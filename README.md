# ğŸµ Loopzz â€” Music & Live Streaming Platform

A full-stack web application where artists share music, go live, and earn tips â€” while fans discover content, chat in real-time, and support their favorite creators.

Built with **Next.js 14**, **NestJS**, **PostgreSQL**, **Prisma**, **Socket.IO**, and **Docker**.

---

## ğŸ“‘ Table of Contents

- [Features](#-features)
- [Tech Stack](#-tech-stack)
- [Architecture](#-architecture)
- [Project Structure](#-project-structure)
- [Prerequisites](#-prerequisites)
- [Getting Started](#-getting-started)
- [Environment Variables](#-environment-variables)
- [Database Schema](#-database-schema)
- [API Reference](#-api-reference)
- [WebSocket Events](#-websocket-events)
- [Frontend Pages](#-frontend-pages)
- [Security](#-security)
- [Troubleshooting](#-troubleshooting)
- [Development Without Docker](#-development-without-docker)
- [License](#-license)

---

## âœ¨ Features

### For Artists
- **Upload Music & Videos** â€” Share tracks (audio) and short-form videos with captions
- **Go Live** â€” Start live streaming sessions with real-time viewer counts
- **Earn Tips** â€” Receive tips from fans with anti-fraud protection (no self-tipping)
- **Earnings Dashboard** â€” Track total earnings, recent tips, and transaction history
- **Referral Rewards** â€” Earn 5% commission on tips generated by referred users

### For Fans
- **AI-Powered Feed** â€” Discover content ranked by an engagement scoring algorithm
- **Live Chat** â€” Join live sessions and chat with other viewers in real-time
- **Tip Artists** â€” Support creators with customizable tip amounts ($5, $10, $25, $50, or custom)
- **Referral Program** â€” Invite friends and earn passive income

### Platform Features
- **JWT Authentication** â€” Secure login/register with bcrypt password hashing (12 rounds)
- **Role-Based Access Control** â€” Three roles: `USER`, `ARTIST`, `ADMIN`
- **Dark Mode** â€” Toggle between light and dark themes with localStorage persistence
- **Responsive Design** â€” Mobile-first UI with TailwindCSS
- **Real-Time Communication** â€” Socket.IO for live chat and WebRTC signaling
- **Rate Limiting** â€” 100 requests per 60 seconds via `@nestjs/throttler`
- **File Upload** â€” Multer-based upload with size limits (100MB video, 50MB audio)

---

## ğŸ›  Tech Stack

### Frontend
| Technology | Purpose |
|---|---|
| [Next.js 14] | React framework with App Router |
| [TypeScript] | Type safety |
| [TailwindCSS] | Utility-first CSS styling |
| [Zustand] | Lightweight state management |
| [Axios] | HTTP client with JWT interceptors |
| [Socket.IO Client] | Real-time WebSocket communication |
| [Lucide React]| Icon library |

### Backend
| Technology | Purpose |
|---|---|
| [NestJS] | Progressive Node.js framework |
| [TypeScript]| Type safety |
| [Prisma] | Type-safe ORM for PostgreSQL |
| [Passport JWT] | Authentication strategy |
| [Socket.IO]| WebSocket server for real-time features |
| [Multer]| Multipart file upload handling |
| [bcrypt] | Password hashing |
| [class-validator] | DTO validation |

### Infrastructure
| Technology | Purpose |
|---|---|
| [PostgreSQL 16] | Relational database |
| [Docker]| Containerization |
| [Docker Compose]| Multi-container orchestration |

---

## ğŸ— Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚â”€â”€â”€â”€â–¶â”‚   Frontend   â”‚â”€â”€â”€â”€â–¶â”‚   Backend    â”‚
â”‚              â”‚     â”‚  Next.js 14  â”‚     â”‚   NestJS     â”‚
â”‚  Port 3001   â”‚     â”‚  Port 3000   â”‚     â”‚  Port 4000   â”‚
â”‚  (external)  â”‚     â”‚  (container) â”‚     â”‚  (container) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚                     â”‚              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚  PostgreSQL  â”‚    â”‚  Socket.IO   â”‚  â”‚  Multer  â”‚
                    â”‚   Port 5432  â”‚    â”‚  WebSocket   â”‚  â”‚  Uploads â”‚
                    â”‚  (internal)  â”‚    â”‚  Gateway     â”‚  â”‚  /uploadsâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Design Decisions:**
- PostgreSQL port is **not exposed** to the host â€” only accessible within the Docker network
- Frontend makes API calls to `http://localhost:4000` from the browser (not container-to-container)
- File uploads are stored in a persistent Docker volume (`uploads`)
- Database data persists across restarts via Docker volume (`pgdata`)

---

## ğŸ“‚ Project Structure

```
loopzz/
â”œâ”€â”€ docker-compose.yml              # Orchestrates all 3 services
â”œâ”€â”€ .env                            # Root environment variables
â”œâ”€â”€ .env.example                    # Template for environment variables
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”‚
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ Dockerfile                  # Multi-stage build (builder + runner)
â”‚   â”œâ”€â”€ .dockerignore               # Excludes node_modules, dist, etc.
â”‚   â”œâ”€â”€ .env                        # Backend-specific env vars
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ nest-cli.json
â”‚   â”‚
â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”œâ”€â”€ schema.prisma           # Database models & enums
â”‚   â”‚   â””â”€â”€ migrations/
â”‚   â”‚       â”œâ”€â”€ migration_lock.toml
â”‚   â”‚       â””â”€â”€ 20240101000000_init/
â”‚   â”‚           â””â”€â”€ migration.sql   # Initial schema creation
â”‚   â”‚
â”‚   â”œâ”€â”€ uploads/                    # File upload directory (Docker volume)
â”‚   â”‚
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.ts                 # App entry point (CORS, validation, static files)
â”‚       â”œâ”€â”€ app.module.ts           # Root module (imports all feature modules)
â”‚       â”‚
â”‚       â”œâ”€â”€ prisma/
â”‚       â”‚   â”œâ”€â”€ prisma.service.ts   # Prisma client lifecycle management
â”‚       â”‚   â””â”€â”€ prisma.module.ts    # Global Prisma module
â”‚       â”‚
â”‚       â”œâ”€â”€ common/
â”‚       â”‚   â”œâ”€â”€ decorators/
â”‚       â”‚   â”‚   â””â”€â”€ roles.decorator.ts   # @Roles('ARTIST') decorator
â”‚       â”‚   â””â”€â”€ guards/
â”‚       â”‚       â””â”€â”€ roles.guard.ts       # Role-based access guard
â”‚       â”‚
â”‚       â”œâ”€â”€ auth/
â”‚       â”‚   â”œâ”€â”€ auth.module.ts      # JWT + Passport configuration
â”‚       â”‚   â”œâ”€â”€ auth.controller.ts  # POST /register, POST /login, GET /me
â”‚       â”‚   â”œâ”€â”€ auth.service.ts     # Registration, login, profile logic
â”‚       â”‚   â”œâ”€â”€ auth.dto.ts         # RegisterDto, LoginDto with validation
â”‚       â”‚   â””â”€â”€ jwt.strategy.ts     # JWT extraction & user validation
â”‚       â”‚
â”‚       â”œâ”€â”€ users/
â”‚       â”‚   â”œâ”€â”€ users.module.ts
â”‚       â”‚   â”œâ”€â”€ users.controller.ts # GET /users/:id, GET /artists, PATCH /profile
â”‚       â”‚   â””â”€â”€ users.service.ts    # User lookup, profile updates, artist listing
â”‚       â”‚
â”‚       â”œâ”€â”€ videos/
â”‚       â”‚   â”œâ”€â”€ videos.module.ts
â”‚       â”‚   â”œâ”€â”€ videos.controller.ts # POST /videos (upload), GET, like
â”‚       â”‚   â””â”€â”€ videos.service.ts    # Upload, view counting, like tracking
â”‚       â”‚
â”‚       â”œâ”€â”€ tracks/
â”‚       â”‚   â”œâ”€â”€ tracks.module.ts
â”‚       â”‚   â”œâ”€â”€ tracks.controller.ts # POST /tracks (artist-only), GET
â”‚       â”‚   â””â”€â”€ tracks.service.ts    # Upload, play counting
â”‚       â”‚
â”‚       â”œâ”€â”€ live/
â”‚       â”‚   â”œâ”€â”€ live.module.ts
â”‚       â”‚   â”œâ”€â”€ live.controller.ts   # POST /start, POST /:id/end, GET active
â”‚       â”‚   â””â”€â”€ live.service.ts      # Session management, viewer tracking
â”‚       â”‚
â”‚       â”œâ”€â”€ tips/
â”‚       â”‚   â”œâ”€â”€ tips.module.ts
â”‚       â”‚   â”œâ”€â”€ tips.controller.ts   # POST /tips, GET by artist/user
â”‚       â”‚   â””â”€â”€ tips.service.ts      # Anti-fraud, earnings update, referral rewards
â”‚       â”‚
â”‚       â”œâ”€â”€ referrals/
â”‚       â”‚   â”œâ”€â”€ referrals.module.ts
â”‚       â”‚   â”œâ”€â”€ referrals.controller.ts # GET /referrals, GET /code
â”‚       â”‚   â””â”€â”€ referrals.service.ts    # Referral tracking, reward calculation
â”‚       â”‚
â”‚       â”œâ”€â”€ transactions/
â”‚       â”‚   â”œâ”€â”€ transactions.module.ts
â”‚       â”‚   â”œâ”€â”€ transactions.controller.ts # GET /transactions, GET /earnings
â”‚       â”‚   â””â”€â”€ transactions.service.ts    # Transaction history, earnings summary
â”‚       â”‚
â”‚       â”œâ”€â”€ feed/
â”‚       â”‚   â”œâ”€â”€ feed.module.ts
â”‚       â”‚   â”œâ”€â”€ feed.controller.ts   # GET /feed, GET /trending
â”‚       â”‚   â””â”€â”€ feed.service.ts      # AI engagement scoring algorithm
â”‚       â”‚
â”‚       â””â”€â”€ chat/
â”‚           â”œâ”€â”€ chat.module.ts
â”‚           â””â”€â”€ chat.gateway.ts      # WebSocket: chat, viewers, WebRTC signaling
â”‚
â””â”€â”€ frontend/
    â”œâ”€â”€ Dockerfile                   # Single-stage build with next start
    â”œâ”€â”€ .env.local                   # Frontend env vars (NEXT_PUBLIC_*)
    â”œâ”€â”€ package.json
    â”œâ”€â”€ tsconfig.json
    â”œâ”€â”€ next.config.js
    â”œâ”€â”€ next-env.d.ts
    â”œâ”€â”€ tailwind.config.js           # Dark mode (class strategy), brand colors
    â”œâ”€â”€ postcss.config.js
    â”‚
    â”œâ”€â”€ public/                      # Static assets
    â”‚
    â””â”€â”€ src/
        â”œâ”€â”€ types/
        â”‚   â””â”€â”€ index.ts             # TypeScript interfaces (User, Video, Track, etc.)
        â”‚
        â”œâ”€â”€ lib/
        â”‚   â”œâ”€â”€ api.ts               # Axios client + all API methods + JWT interceptor
        â”‚   â””â”€â”€ socket.ts            # Socket.IO client singleton
        â”‚
        â”œâ”€â”€ store/
        â”‚   â”œâ”€â”€ authStore.ts         # Zustand: user, token, login/register/logout
        â”‚   â””â”€â”€ uiStore.ts           # Zustand: dark mode toggle
        â”‚
        â”œâ”€â”€ components/
        â”‚   â””â”€â”€ layout/
        â”‚       â”œâ”€â”€ Navbar.tsx        # Responsive nav with dark mode, auth state
        â”‚       â””â”€â”€ Providers.tsx     # Auth loader + dark mode initializer
        â”‚
        â””â”€â”€ app/
            â”œâ”€â”€ globals.css           # TailwindCSS + custom component classes
            â”œâ”€â”€ layout.tsx            # Root layout with Providers
            â”œâ”€â”€ page.tsx              # Landing page (hero, features, CTA)
            â”‚
            â”œâ”€â”€ auth/
            â”‚   â”œâ”€â”€ login/
            â”‚   â”‚   â””â”€â”€ page.tsx      # Login form with error handling
            â”‚   â””â”€â”€ register/
            â”‚       â””â”€â”€ page.tsx      # Registration with role selection + referral
            â”‚
            â”œâ”€â”€ feed/
            â”‚   â””â”€â”€ page.tsx          # AI-ranked content feed (videos + tracks)
            â”‚
            â”œâ”€â”€ dashboard/
            â”‚   â””â”€â”€ page.tsx          # Role-based dashboard (fan vs artist)
            â”‚
            â”œâ”€â”€ upload/
            â”‚   â””â”€â”€ page.tsx          # File upload with video/track tabs
            â”‚
            â””â”€â”€ live/
                â”œâ”€â”€ page.tsx          # Active sessions list + start session
                â””â”€â”€ [id]/
                    â””â”€â”€ page.tsx      # Live viewer: stream, chat, tipping
```

---

## ğŸ“‹ Prerequisites

You only need **Docker Desktop** installed:

Verify installation:

```bash
docker --version
# Docker version 24.x or higher

docker compose version
# Docker Compose version v2.x
```

---

## ğŸš€ Getting Started

### 1. Clone the Repository

```bash
git clone https://github.com/YOUR_USERNAME/loopzz.git
cd loopzz
```

### 2. Start Docker Desktop

Make sure Docker Desktop is running (green "Engine running" indicator).

### 3. Build & Start All Services

```bash
docker compose up --build
```

**First run takes 3â€“5 minutes** (downloading images + installing dependencies).

You'll know it's ready when you see:

```
loopzz-backend   | Loopzz Backend running on http://localhost:4000
loopzz-frontend  |  âœ“ Ready in 557ms
```

### 4. Open the App

| Service | URL |
|---|---|
| **Frontend** | [http://localhost:3000] |
| **Backend API** | [http://localhost:4000] |

> **âš ï¸ Port 3000 already in use?** Change `"3000:3000"` to `"3001:3000"` in `docker-compose.yml`, then open `http://localhost:3001` instead.

### 5. Create Accounts & Explore

1. **Register as an Artist** â€” Click Sign up â†’ enter details â†’ select ğŸ¤ Artist
2. **Register as a Fan** (in incognito/another browser) â€” select ğŸ§ Fan
3. **Upload content** â€” Go to Upload â†’ add a video or music track
4. **Browse the Feed** â€” See AI-ranked content on the Feed page
5. **Go Live** â€” As an Artist, start a live session from the Live page
6. **Join & Chat** â€” As a Fan, click into the live session and send messages
7. **Send Tips** â€” Click the Tip button during a live session
8. **Check Dashboard** â€” View earnings, referrals, and stats

### 6. Stop the App

```bash
# Stop all containers
docker compose down

# Stop AND delete all data (fresh start)
docker compose down -v
```

### 7. Restart Later

```bash
docker compose up
```

No `--build` needed on subsequent runs unless you change source code.

---

## âš™ï¸ Environment Variables

### Root `.env`

```env
POSTGRES_USER=loopzz
POSTGRES_PASSWORD=loopzz_secret
POSTGRES_DB=loopzz
```

### Backend (set in `docker-compose.yml`)

| Variable | Default | Description |
|---|---|---|
| `DATABASE_URL` | `postgresql://loopzz:loopzz_secret@postgres:5432/loopzz?schema=public` | PostgreSQL connection string |
| `JWT_SECRET` | `super_secret_jwt_key_change_in_production` | Secret for signing JWT tokens |
| `PORT` | `4000` | Backend server port |
| `CORS_ORIGIN` | `http://localhost:3000` | Allowed CORS origin |

### Frontend (set in `docker-compose.yml`)

| Variable | Default | Description |
|---|---|---|
| `NEXT_PUBLIC_API_URL` | `http://localhost:4000` | Backend API URL (called from browser) |
| `NEXT_PUBLIC_WS_URL` | `ws://localhost:4000` | WebSocket URL for Socket.IO |

> **âš ï¸ For production:** Change `JWT_SECRET` to a long random string, update `CORS_ORIGIN`, and use proper database credentials.

---

## ğŸ—„ Database Schema

### Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     User     â”‚â”€â”€1:1â”€â”€â”‚  ArtistProfile   â”‚â”€â”€1:Nâ”€â”€â”‚    Track     â”‚
â”‚              â”‚       â”‚                  â”‚       â”‚              â”‚
â”‚ id (uuid)    â”‚       â”‚ id (uuid)        â”‚       â”‚ id (uuid)    â”‚
â”‚ email        â”‚       â”‚ userId (FK)      â”‚       â”‚ artistId (FK)â”‚
â”‚ password     â”‚       â”‚ bio              â”‚       â”‚ url          â”‚
â”‚ username     â”‚       â”‚ verified         â”‚       â”‚ title        â”‚
â”‚ role (enum)  â”‚       â”‚ earnings         â”‚       â”‚ plays        â”‚
â”‚ avatar       â”‚       â”‚                  â”‚       â”‚ duration     â”‚
â”‚ createdAt    â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ updatedAt    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
       â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚â”€â”€1:Nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  LiveSession   â”‚
       â”‚                â”‚                â”‚
       â”‚                â”‚ id (uuid)      â”‚
       â”‚                â”‚ artistId (FK)  â”‚
       â”‚                â”‚ title          â”‚
       â”‚                â”‚ isActive       â”‚
       â”‚                â”‚ viewers        â”‚
       â”‚                â”‚ startedAt      â”‚
       â”‚                â”‚ endedAt        â”‚
       â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚â”€â”€1:Nâ”€â”€â–¶ Video (id, userId, url, caption, views, likes, createdAt)
       â”‚
       â”‚â”€â”€1:Nâ”€â”€â–¶ Tip (id, fromUserId, toArtistId, amount, message, createdAt)
       â”‚
       â”‚â”€â”€1:Nâ”€â”€â–¶ Transaction (id, userId, type, amount, status, metadata, createdAt)
       â”‚
       â”‚â”€â”€1:Nâ”€â”€â–¶ Referral (id, referrerId, referredId, rewardEarned, createdAt)
```

### Enums

```
Role:              USER | ARTIST | ADMIN
TransactionType:   TIP_SENT | TIP_RECEIVED | REFERRAL_REWARD | WITHDRAWAL
TransactionStatus: PENDING | COMPLETED | FAILED
```

---

## ğŸ“¡ API Reference

All endpoints are prefixed with `http://localhost:4000`.

### Authentication

| Method | Endpoint | Auth | Body | Description |
|---|---|---|---|---|
| `POST` | `/auth/register` | No | `{ email, username, password, role?, referralCode? }` | Create account |
| `POST` | `/auth/login` | No | `{ email, password }` | Login, returns JWT |
| `GET` | `/auth/me` | Yes | â€” | Get current user profile |

**Register example:**

```bash
curl -X POST http://localhost:4000/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "artist@example.com",
    "username": "coolartist",
    "password": "password123",
    "role": "ARTIST"
  }'
```

**Response:**

```json
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "artist@example.com",
    "username": "coolartist",
    "role": "ARTIST"
  }
}
```

**Login example:**

```bash
curl -X POST http://localhost:4000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "artist@example.com", "password": "password123"}'
```

**Using the token (all authenticated endpoints):**

```bash
curl http://localhost:4000/auth/me \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### Videos

| Method | Endpoint | Auth | Description |
|---|---|---|---|
| `POST` | `/videos` | Yes | Upload video (multipart, max 100MB) |
| `GET` | `/videos?page=1&limit=20` | No | List all videos (paginated) |
| `GET` | `/videos/:id` | No | Get video (increments views) |
| `POST` | `/videos/:id/like` | Yes | Like a video |
| `GET` | `/videos/user/:userId` | No | Get videos by user |

**Upload example:**

```bash
curl -X POST http://localhost:4000/videos \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@video.mp4" \
  -F "caption=My first video!"
```

### Tracks (Artist Only)

| Method | Endpoint | Auth | Description |
|---|---|---|---|
| `POST` | `/tracks` | Yes (ARTIST) | Upload track (multipart, max 50MB) |
| `GET` | `/tracks?page=1&limit=20` | No | List all tracks (paginated) |
| `GET` | `/tracks/:id` | No | Get track (increments plays) |
| `GET` | `/tracks/artist/:artistId` | No | Get tracks by artist |

### Live Sessions

| Method | Endpoint | Auth | Description |
|---|---|---|---|
| `POST` | `/live/start` | Yes (ARTIST) | Start live session `{ title }` |
| `POST` | `/live/:id/end` | Yes (ARTIST) | End live session |
| `GET` | `/live` | No | Get all active sessions |
| `GET` | `/live/:id` | No | Get session details |

### Tips

| Method | Endpoint | Auth | Description |
|---|---|---|---|
| `POST` | `/tips` | Yes | Send tip `{ toArtistId, amount, message? }` |
| `GET` | `/tips/artist/:artistId` | Yes | Tips received by artist |
| `GET` | `/tips/my` | Yes | Tips sent by current user |

### Feed

| Method | Endpoint | Auth | Description |
|---|---|---|---|
| `GET` | `/feed?page=1&limit=20` | No | AI-ranked feed (videos + tracks) |
| `GET` | `/feed/trending` | No | Trending videos, tracks, artists |

**AI Ranking Algorithm:**

```
score = (views Ã— 0.3) + (likes Ã— 2) + (engagement_rate Ã— 10) + recency_boost

where:
  engagement_rate = (likes / views) Ã— 100
  recency_boost = max(0, 100 - age_in_hours Ã— 2)
```

### Transactions

| Method | Endpoint | Auth | Description |
|---|---|---|---|
| `GET` | `/transactions?page=1` | Yes | Transaction history |
| `GET` | `/transactions/earnings` | Yes | Earnings summary (artists) |

### Referrals

| Method | Endpoint | Auth | Description |
|---|---|---|---|
| `GET` | `/referrals` | Yes | My referrals + total earned |
| `GET` | `/referrals/code` | Yes | Get my referral code |

### Users

| Method | Endpoint | Auth | Description |
|---|---|---|---|
| `GET` | `/users/:id` | No | Get user by ID |
| `GET` | `/users/artists` | No | List all artists |
| `PATCH` | `/users/profile` | Yes | Update username/bio |

---

## ğŸ”Œ WebSocket Events

Connect to `ws://localhost:4000` via Socket.IO.

### Live Session Events

| Event | Direction | Payload | Description |
|---|---|---|---|
| `join-session` | Client â†’ Server | `{ sessionId, username }` | Join a live session room |
| `leave-session` | Client â†’ Server | `{ sessionId, username }` | Leave a live session room |
| `chat-message` | Client â†’ Server | `{ sessionId, userId, username, message }` | Send chat message |
| `chat-message` | Server â†’ Client | `{ sessionId, userId, username, message, timestamp }` | Receive chat message |
| `viewer-count` | Server â†’ Client | `{ sessionId, count }` | Updated viewer count |
| `user-joined` | Server â†’ Client | `{ username }` | User joined notification |
| `user-left` | Server â†’ Client | `{ username }` | User left notification |

### WebRTC Signaling

| Event | Direction | Payload | Description |
|---|---|---|---|
| `start-broadcast` | Client â†’ Server | `{ sessionId }` | Artist starts broadcasting |
| `broadcast-started` | Server â†’ Client | `{ broadcasterId }` | Notify viewers of broadcast |
| `webrtc-offer` | Client â†’ Server | `{ sessionId, offer }` | SDP offer |
| `webrtc-answer` | Client â†’ Server | `{ sessionId, answer, to }` | SDP answer |
| `webrtc-ice-candidate` | Both | `{ sessionId, candidate, to? }` | ICE candidate exchange |

---

## ğŸ–¥ Frontend Pages

| Route | Page | Auth Required | Description |
|---|---|---|---|
| `/` | Landing | No | Hero section, feature cards, CTA buttons |
| `/auth/login` | Login | No | Email/password form |
| `/auth/register` | Register | No | Form with role selection (Fan/Artist) + referral support |
| `/feed` | Feed | No | AI-ranked content feed with like/play actions |
| `/dashboard` | Dashboard | Yes | Stats cards, referral link, recent tips, video list |
| `/upload` | Upload | Yes | Drag-and-drop upload with video/track tabs |
| `/live` | Live Sessions | No | Grid of active sessions + start session (artists) |
| `/live/[id]` | Live Viewer | No | Stream view, real-time chat, tipping modal |

---

## ğŸ”’ Security

| Feature | Implementation |
|---|---|
| **Password Hashing** | bcrypt with 12 salt rounds |
| **Authentication** | JWT with 7-day expiration |
| **Token Transport** | Bearer token in Authorization header |
| **Role-Based Access** | Custom `@Roles()` decorator + `RolesGuard` |
| **Input Validation** | `class-validator` with whitelist + forbidNonWhitelisted |
| **Rate Limiting** | 100 requests per 60 seconds (`@nestjs/throttler`) |
| **CORS** | Configured origin whitelist |
| **Anti-Fraud** | Self-tipping prevention, tip amount validation ($0â€“$10,000) |
| **Auto-Logout** | Frontend interceptor clears token on 401 response |

---

## ğŸ”§ Troubleshooting

### "Port already allocated"

Something else is using port 3000 or 4000.

```bash
# Windows â€” find and kill the process
netstat -ano | findstr :3000
taskkill /PID <PID_NUMBER> /F

# macOS/Linux
lsof -i :3000
kill -9 <PID>
```

Or change the port in `docker-compose.yml`:

```yaml
# Change frontend port
ports:
  - "3001:3000"  # Access via http://localhost:3001
```

### "Docker engine not running" / "pipe not found"

1. Open **Docker Desktop** from Start Menu / Applications
2. Wait for the green "Engine running" indicator
3. Open a **new** terminal window (old terminals won't have the pipe)

### "ERR_EMPTY_RESPONSE" on frontend

The Next.js server isn't binding correctly. Check logs:

```bash
docker logs loopzz-frontend
```

If it shows "Ready" but still doesn't work, the host binding failed. The Dockerfile uses `HOSTNAME=0.0.0.0` to bind to all interfaces.

### Backend crashes on startup

```bash
# Check logs
docker logs loopzz-backend

# Common fix: database wasn't ready, just restart
docker compose down
docker compose up
```

### Prisma migration errors

```bash
# Reset everything
docker compose down -v
docker compose up --build
```

### Registration/login fails

Check backend logs immediately after trying:

```bash
docker logs loopzz-backend --tail 10
```

Test the API directly:

```bash
curl -X POST http://localhost:4000/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","username":"testuser","password":"password123","role":"USER"}'
```

### Want to start completely fresh

```bash
docker compose down -v        # Remove containers + volumes
docker system prune -a        # Remove all unused Docker data
docker compose up --build     # Rebuild everything from scratch
```

---

## ğŸ’» Development Without Docker

If you prefer running services individually for development:

### 1. Start PostgreSQL Only

```bash
docker compose up postgres -d
```

### 2. Run Backend

```bash
cd backend
npm install

# Set environment
export DATABASE_URL="postgresql://loopzz:loopzz_secret@localhost:5432/loopzz?schema=public"
export JWT_SECRET="super_secret_jwt_key_change_in_production"
export PORT=4000
export CORS_ORIGIN="http://localhost:3000"

# Generate Prisma client & run migrations
npx prisma generate
npx prisma migrate deploy

# Start in dev mode (hot reload)
npm run start:dev
```

Backend runs on `http://localhost:4000`.

### 3. Run Frontend

```bash
cd frontend
npm install

# Start in dev mode (hot reload)
npm run dev
```

Frontend runs on `http://localhost:3000`.

---

## ğŸ“ License

This project is open source and available under the [MIT License](LICENSE).

---

**Built with â¤ï¸ using Next.js, NestJS, and PostgreSQL**
